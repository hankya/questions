from scrapy.spider import BaseSpider
from redis import StrictRedis
from PIL import Image
import hashlib

class TempSpider (BaseSpider):

    name = 'image'
    redis_cli = StrictRedis(host='localhost', port=6379, db=0)
    
    def start_requests(self):
        for url in self.redis_cli.smembers('temp'):
            req = self.make_requests_from_url(url)
            yield req
       
    def parse(self, response):
        image = Image.open(StringIO(response.body))
        filename = self.get_path_from_url(response.url)
        image.save(os.path.join('screenshots/images', filename))
        pass

    def get_path_from_url(self, url):
        tokens = url.split('/')
        return '%s.%s' % (hashlib.sha1(url).hexdigest(), tokens[-1].split('.')[-1])
