from lxml import html
import re
abs_url_pattern = re.compile('http://[^/]+/.*')

def rewrite_imgsrc(value):
    return [_rewrite_imgsrc(v) for v in value] if hasattr(value, '__iter__') else _rewrite_imgsrc(value)    
    
def _rewrite_imgsrc(value):
    hdoc = html.fromstring(value)
    imgs = hdoc.xpath('//img')
    for img in imgs:
        img_link = img.get('src')
        if abs_url_pattern.match(img_link):
            img.set('src', '/'.join(img_link.split('/')[3:]) )
    #or return html.tostring(hdoc, encoding='utf8').decode('utf8')
    return html.tostring(hdoc, encoding='unicode')

class UrlRewriterPipeline(object):
    def process_item(self, item, spider):
        item['question_answer_html'] = rewrite_imgsrc(item['question_answer_html'])
        item['question_analysis_html'] = rewrite_imgsrc(item['question_analysis_html']
        item['question_content_html'] = rewrite_imgsrc(item['question_content_html'])
        return item
